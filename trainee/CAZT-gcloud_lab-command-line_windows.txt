# Assumes Powershell 5 or later with Windows 10 21H2 or later
# admin should not be needed unless you installed gcloud and python as All Users admin required

# Assumes you already installed Python 3 for Windows

# Assumes you already installed gcloud CLI for Windows

# Assumes burp is already running


$LAB_IP = "TODO"


ping $LAB_IP


cd $Env:USERPROFILE\Downloads


# ======================================

# Google cloud setup


# Burp Setup

$Env:https_proxy = "http://localhost:8080"


curl.exe --output burp-ca.der http://localhost:8080/cert

# IMPORTANT IMPORTANT IMPORTANT 
# Use Windows GUI to convert the der to base64 pem


$Env:CLOUDSDK_CORE_custom_ca_certs_file = "$pwd\burp-ca.cer"


#####

# if needed
#    $Env:PATH = "$Env:USERPROFILE\AppData\Local\Programs\Python\Python313;$Env:PATH"

cd .\cazt-main\trainee\cloud-clients\gcloud\

Set-ExecutionPolicy -ExecutionPolicy Bypass -Scope Process

python install-cazt-into-gcloud-cli-for-powershell


cd $Env:USERPROFILE\Downloads

#####

# gcloud newer version is more strict about self-signed certificates and not trusting them
# In-case you are not using Burp then this bypasses that
gcloud config set auth/disable_ssl_validation  True


gcloud cazt create `
    --api-endpoint-overrides=https://${LAB_IP}:8443/uat `
    --account=cazt_scen0_Setup-Any@000000001111 `
    --format json `
    --name=MyMoggy `
    --activity-log-object-storage=moggylitterbox-000000001111

gcloud cazt create `
    --api-endpoint-overrides=https://${LAB_IP}:8443/uat `
    --account=cazt_scen0_Setup-Any@000000002222 `
    --format json `
    --name=NotMyMoggy `
    --activity-log-object-storage=moggylitterbox-000000002222


gcloud cazt run-activity `
    --api-endpoint-overrides=https://${LAB_IP}:8443/uat `
	--account=cazt_scen0_Setup-Any@000000001111 `
	--format json `
	--arn=arn:cloud:cazt:us-texas-9:000000001111:MyMoggy
